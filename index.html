<?php
session_start();

// Адмін
define('ADMIN_EMAIL', 'lisovecartem333@gmail.com');
define('ADMIN_PASSWORD', 'admin_zdo_2024');

// Створюємо папки
if(!is_dir('uploads')) mkdir('uploads', 0777, true);
if(!is_dir('uploads/photos')) mkdir('uploads/photos', 0777, true);
if(!is_file('uploads/files.json')) file_put_contents('uploads/files.json', '[]');
if(!is_file('uploads/news.json')) file_put_contents('uploads/news.json', '[]');
if(!is_file('uploads/comments.json')) file_put_contents('uploads/comments.json', '[]');

// Логін
if(isset($_POST['login'])) {
    $email = $_POST['email'] ?? '';
    $pass = $_POST['password'] ?? '';
    if($email === ADMIN_EMAIL && $pass === ADMIN_PASSWORD){
        $_SESSION['isAdmin'] = true;
    } else {
        $login_error = "Невірний логін або пароль";
    }
}

// Вихід
if(isset($_GET['logout'])) {
    session_destroy();
    header("Location: index.php");
    exit;
}

// Завантаження файлів
if(isset($_POST['upload']) && isset($_SESSION['isAdmin']) && $_SESSION['isAdmin']) {
    $fileTitle = $_POST['fileTitle'] ?? '';
    $fileDesc = $_POST['fileDesc'] ?? '';
    $fileCat = $_POST['fileCat'] ?? '';
    
    if(isset($_FILES['file']) && $_FILES['file']['error'] == 0) {
        $filename = basename($_FILES['file']['name']);
        $target = "uploads/" . time() . "_" . preg_replace('/\s+/', '_', $filename);
        if(move_uploaded_file($_FILES['file']['tmp_name'], $target)){
            $files = json_decode(file_get_contents('uploads/files.json'), true);
            $files[] = [
                'title' => htmlspecialchars($fileTitle),
                'desc' => htmlspecialchars($fileDesc),
                'cat' => htmlspecialchars($fileCat),
                'path' => $target,
                'date' => date("d.m.Y H:i")
            ];
            file_put_contents('uploads/files.json', json_encode($files, JSON_PRETTY_PRINT));
            $upload_success = "Файл успішно додано!";
        }
    }
}

// Завантаження фото
if(isset($_POST['uploadPhoto']) && isset($_SESSION['isAdmin']) && $_SESSION['isAdmin']) {
    if(isset($_FILES['photo']) && $_FILES['photo']['error'] == 0){
        $filename = basename($_FILES['photo']['name']);
        $target = "uploads/photos/" . time() . "_" . preg_replace('/\s+/', '_', $filename);
        if(move_uploaded_file($_FILES['photo']['tmp_name'], $target)){
            $photos = json_decode(file_get_contents('uploads/photos.json') ?? '[]', true);
            $photos[] = ['path'=>$target,'date'=>date("d.m.Y H:i")];
            file_put_contents('uploads/photos.json', json_encode($photos, JSON_PRETTY_PRINT));
            $upload_success = "Фото успішно додано!";
        }
    }
}

// Додавання новини
if(isset($_POST['addNews']) && isset($_SESSION['isAdmin']) && $_SESSION['isAdmin']){
    $newsTitle = $_POST['newsTitle'] ?? '';
    $newsDesc = $_POST['newsDesc'] ?? '';
    if($newsTitle && $newsDesc){
        $news = json_decode(file_get_contents('uploads/news.json'), true);
        $news[] = ['title'=>htmlspecialchars($newsTitle),'desc'=>htmlspecialchars($newsDesc),'date'=>date("d.m.Y H:i")];
        file_put_contents('uploads/news.json', json_encode($news, JSON_PRETTY_PRINT));
        $news_success = "Новина додана!";
    }
}

// Додавання коментаря
if(isset($_POST['addComment'])){
    $comment = $_POST['comment'] ?? '';
    if($comment){
        $comments = json_decode(file_get_contents('uploads/comments.json'), true);
        $comments[] = ['comment'=>htmlspecialchars($comment),'date'=>date("d.m.Y H:i")];
        file_put_contents('uploads/comments.json', json_encode($comments, JSON_PRETTY_PRINT));
        $comment_success = "Коментар додано!";
    }
}

// Читання даних
$allFiles = json_decode(file_get_contents('uploads/files.json'), true);
$allPhotos = json_decode(file_get_contents('uploads/photos.json') ?? '[]', true);
$allNews = json_decode(file_get_contents('uploads/news.json') ?? '[]', true);
$allComments = json_decode(file_get_contents('uploads/comments.json') ?? '[]', true);
?>
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Дитячий садок ЗДО | Офіційний сайт</title>
<meta name="google-site-verification" content="ТУТ_ПОСТАВЬ_СВІЙ_КОД_ВІД_GSC" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root { --primary: #2E8B57; --secondary: #4a90e2; --accent: #FF6B35; --light: #f8f9fa; --dark: #2c3e50; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f5f7fa; color: #333; margin:0; padding:0;}
header { background: linear-gradient(135deg, var(--primary), #3CB371); color:white; padding:10px; position:fixed; width:100%; top:0; z-index:1000;}
header a.logo { color:white; text-decoration:none; font-weight:bold; font-size:1.5rem;}
nav { margin-top:70px; background:white; display:flex; overflow-x:auto;}
nav button { padding:15px 20px; border:none; background:none; cursor:pointer; font-weight:600;}
nav button.active { border-bottom:3px solid var(--primary);}
.container { max-width:1200px; margin:0 auto; padding:20px; margin-top:140px;}
.section { display:none; }
.section.active { display:block; }
.card { background:white; padding:20px; margin-bottom:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.05);}
.btn { padding:10px 20px; border:none; border-radius:50px; background:var(--accent); color:white; cursor:pointer; margin-top:10px;}
.btn:hover { background:#e55a2b; }
.files-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap:15px; margin-top:20px;}
.file-item { background:white; padding:10px; border-left:4px solid var(--primary); border-radius:8px; display:flex; flex-direction:column; box-shadow:0 3px 10px rgba(0,0,0,0.05);}
.photos-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:15px; margin-top:20px;}
.photos-list img { width:100%; border-radius:10px; }
.comment-item { background:white; padding:10px; margin-bottom:10px; border-left:4px solid var(--secondary); border-radius:8px; }
</style>
</head>
<body>
<header>
    <a href="#" class="logo" onclick="showTab('home')"><i class="fas fa-seedling"></i> ДИТЯЧИЙ САДОК ЗДО</a>
</header>
<nav>
    <button class="tab-btn active" onclick="showTab('home')">Головна</button>
    <button class="tab-btn" onclick="showTab('photo')">Фотоальбом</button>
    <button class="tab-btn" onclick="showTab('attestation')">Атестація педагогів</button>
    <button class="tab-btn" onclick="showTab('collective')">Педагогічний колектив</button>
    <button class="tab-btn" onclick="showTab('statute')">Статут</button>
    <button class="tab-btn" onclick="showTab('files')">Файли</button>
    <button class="tab-btn" onclick="showTab('news')">Новини</button>
    <button class="tab-btn" onclick="showTab('comments')">Обговорення</button>
    <button class="tab-btn" onclick="showTab('admin')">Адмінка</button>
</nav>

<div class="container">
<div id="home" class="section active">
<h1>Ласкаво просимо до нашого садочка!</h1>
<p>Тут ви можете переглядати файли, фото, новини та коментарі.</p>
</div>

<div id="photo" class="section">
<h1>Фотоальбом</h1>
<div class="photos-list">
<?php foreach($allPhotos as $p): ?>
<img src="<?= $p['path'] ?>" alt="Фото">
<?php endforeach; ?>
</div>
<?php if(isset($_SESSION['isAdmin']) && $_SESSION['isAdmin']): ?>
<form method="post" enctype="multipart/form-data">
<input type="file" name="photo" required>
<button class="btn" type="submit" name="uploadPhoto">Додати фото</button>
</form>
<?php endif; ?>
</div>

<div id="attestation" class="section"><h1>Атестація педагогічних працівників</h1></div>
<div id="collective" class="section"><h1>Педагогічний колектив</h1></div>
<div id="statute" class="section"><h1>Статут</h1></div>
